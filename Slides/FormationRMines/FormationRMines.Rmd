---
title: "Visualisation<br>and other cool things with R"
# subtitle: "R Users Grenoble"
author: 'Antoine Bichat'
date: "Mines Nancy<br>December 15, 2017"
output:
  xaringan::moon_reader:
    includes:
      after_body: include_twitter.html
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    # yolo: true
---
class: center, middle, inverse

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(cache = TRUE, fig.align = "center", dev = "svg")
```

```{r otherspack, include=FALSE, message=FALSE}
library(DT)
library(htmltools)
```
#Good practices

---
##Writing code

* Use the arrow for assignation and equal sign for argument setting

* Leave space after commas, and around arrows and equal signs

* Use line breaks

--

```{r writing, message=FALSE, fig.height=3}
x <- rnorm(n = 100, mean = 3, sd = 0.1)

hist(x, col = "grey", border = "black", breaks = 30,
     main = "Normal distribution", xlab = "", ylab = "Frequency")
```

---
## Pipe operator %>%

```{r pipe1, message=FALSE}
# install.packages("magrittr")
library(magrittr)
```

* To express clearly a sequence of multiple operations

* `x %>% f` is equivalent to `f(x)`

* `x %>% f(y)` is equivalent to `f(x, y)`

--

```{r pipe2, message=FALSE}
round(mean(sqrt(1:9), na.rm = TRUE), digits = 2)
```

--

```{r pipe3, message=FALSE}
1:9 %>%
  sqrt %>%
  mean(na.rm = TRUE) %>%
  round(digits = 2)
```

---
class: center, middle
<blockquote class="twitter-tweet" data-lang="fr" align="center"><p lang="en" dir="ltr">This is a reason for pipes.  <a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw">#rstats</a> <a href="https://t.co/SFKVN2GpZZ">pic.twitter.com/SFKVN2GpZZ</a></p>&mdash; Tajti András (@atajti) <a href="https://twitter.com/atajti/status/889112630673235968?ref_src=twsrc%5Etfw">23 juillet 2017</a></blockquote>
<br>
<blockquote class="twitter-tweet" data-lang="fr" align="center"><p lang="en" dir="ltr">And once again, Stackoverflow reminds us why we REALLY need the pipe. <a href="https://twitter.com/hashtag/RStats?src=hash&amp;ref_src=twsrc%5Etfw">#RStats</a> <a href="https://twitter.com/hashtag/tidyverse?src=hash&amp;ref_src=twsrc%5Etfw">#tidyverse</a> <a href="https://t.co/diXgQiVMhO">pic.twitter.com/diXgQiVMhO</a></p>&mdash; Colin Fay (@_ColinFay) <a href="https://twitter.com/_ColinFay/status/889901747480793090?ref_src=twsrc%5Etfw">25 juillet 2017</a></blockquote>

---
<img src="so-logo.png" alt="Drawing" style="width: 410px;"/>

.center[
<img src="so-meme.png" alt="Drawing" style="width: 380px;"/>
]

---
class: middle, center, inverse

#Tips with R and RStudio

---
### Keybord shortcuts

* Ctrl+L: clears console

* Ctrl+Enter: runs selection

* Ctrl+Shift+C: (un)comments selection

* Ctrl+D: deletes selection

* Alt+- : inserts arrow with spaces

.footnote[
[*] It's Command on Macs.
]
--

### Code shortcuts

* `rm(list = ls())` removes all objects from the current workspace

* `graphics.off()` shuts down all open graphics devices

* `cat("\014")` clears console

---
## Not recommended code tips 

```{r ntips}
sqrt(x <- 4) ; x ; 3 -> y ; y
```
---

## Useful code tips

```{r tips}
(x <- LETTERS[1:4])
x %<>% tolower
x
dput(x)
```

---
## Time and {beepr}

```{r time1}
T1 <- Sys.time()
m4 <- rnorm(n = 100000)^4
T2 <- Sys.time()
difftime(T2, T1)
mean(m4)
```
```{r time2, eval=FALSE}
# install.packages("beepr")
library(beepr)
beep()
```

---
##TeleR

.center[
<img src="TeleR1.png" alt="Drawing" style="height: 490px;"/>
<img src="TeleR2.png" alt="Drawing" style="height: 490px;"/>
]

---
class: middle, center, inverse

#Visualisation
##With [**ggplot2**](http://ggplot2.org/)

---
## Iris dataset

```{r iris1, echo=FALSE}
data(iris)
datatable(iris, fillContainer = FALSE, options = list(pageLength = 7))
```

---
##Scatterplot

```{r iris2, fig.height=4}
# install.packages("ggplot2")
library(ggplot2)
ggplot(iris) + geom_point(aes(x = Sepal.Length, y = Petal.Length))
```

---
##Scatterplot with legend

```{r iris3, fig.height=3.5}
ggplot(iris) + 
  geom_point(aes(x = Sepal.Length, y = Petal.Length, 
                 color = Species, shape = Species)) +
  labs(x = "Sepal length", y = "Petal Length") +
  theme_bw()
```

---
## Histogram

```{r iris4, fig.height=3.5, message=FALSE}
ggplot(iris) + 
  geom_histogram(aes(x = Sepal.Length), 
                 fill = "grey50", color = "black") +
  labs(x = "Sepal length", y = "Count") +
  theme_bw()
```

---
## Histogram with facetting

```{r iris5, fig.height=3.2, message=FALSE}
ggplot(iris) + 
  geom_histogram(aes(x = Sepal.Length, fill = Species), 
                 color = "black") +
  facet_grid(.~Species) +
  labs(x = "Sepal length", y = "Count") +
  theme_bw()
```

---
## Boxplot

```{r iris6, fig.height=3, message=FALSE}
p <- ggplot(iris) + 
  geom_boxplot(aes(x = Species, y = Sepal.Length, fill = Species),
               alpha = 0.7) +
  scale_fill_manual(values = c("firebrick", "forestgreen", "royalblue")) +
  labs(x = "Species", y = "Sepal length") 
p + theme_bw()
```

---
##Theory of data visualisation

ggplot stands for __Grammar of Graphics__

<br>

```
ggplot(data = <DATA>) + 
  <GEOM_FUNCTION>(mapping = aes(<MAPPINGS>), 
                  stat = <STAT>, position = <POSITION>) +
  <COORDINATE_FUNCTION> +
  <FACET_FUNCTION>
```

<br>


You can uniquely describe any plot as a combination of these 7 parameters.

---
<br>
<br>
<blockquote class="twitter-tweet" data-lang="fr" align="center"><p lang="en" dir="ltr">Then comes the inevitable &quot;rotate ggplot2 axes&quot; google, which brings me to this life-saving <a href="https://twitter.com/StackOverflow?ref_src=twsrc%5Etfw">@StackOverflow</a> post: <a href="https://t.co/ZuZH52wsYZ">https://t.co/ZuZH52wsYZ</a></p>&mdash; Tanya Cashorali (@tanyacash21) <a href="https://twitter.com/tanyacash21/status/910241426453270528?ref_src=twsrc%5Etfw">19 septembre 2017</a></blockquote>

---
class: center, middle, inverse
# Data manipulation
##with the [**tidyverse**](https://www.tidyverse.org/)

---
##Tidyverse ?
```{r tidyverse, warning=FALSE}
# install.packages("tidyverse")
library(tidyverse)
```

Tidyverse is a collection of packages designed for data science

<br>

We will use {ggplot2}, {dplyr} and {tidyr}

<br>

It imports the `%>%` pipe from {magrittr} but not the `%<>%` pipe

<br>

There are also the {purrr}, {readr} and {tibble} packages

---
## Diamonds dataset

```{r diamonds1, warning=FALSE}
data(diamonds) # {ggplot2}
```

```{r diamonds2, echo=FALSE}
knitr::kable(head(diamonds, n=10), format = 'html')
```

---
## group_by() and summarise()

```{r diamonds3}
diamonds %>% 
  group_by(cut) %>% 
  summarise(Mean = mean(carat), Max = max(carat)) %>% 
  knitr::kable(format = 'html')
```

---
## filter(), mutate(), arrange(), and select()

```{r diamonds4, warning=FALSE}
diamonds %>%
  filter(x>0 & y>0 & z>0) %>%
  mutate(vol = x*y*z) %>%
  arrange(vol) %>%
  select(carat, cut, color, x, y, z, vol) %>%
  head %>% 
  knitr::kable(format = 'html')
```

---
## Use with {ggplot2}

```{r diamonds5, fig.height=3, message=FALSE}
color_cut <- diamonds %>% 
  group_by(color, cut) %>%
  summarise(price = mean(price))

ggplot(color_cut, aes(x = color, y = price)) +
  geom_line(aes(group = cut), color = "grey80") +
  geom_point(aes(color = cut)) +
  theme_bw()
```

---

```{r diamonds6, fig.height=3, message=FALSE}
diamonds_count <- diamonds %>% 
  group_by(color) %>%
  summarise(count = n())

ggplot() +
  geom_bar(data = diamonds, 
           aes(x = color, fill = color), color = "black") +
  geom_text(data = diamonds_count, 
            aes(label = count, x = color, y = count/2)) +
  theme_bw() +
  theme(axis.title.x = element_blank(), legend.position = "none") +
  labs(y = "Count")
```

---
## Tidy data

.center[
<img src="tidy.png" alt="Drawing" style="height: 240px;"/>
]

1. Each variable forms a column

2. Each observation forms a row

3. Each type of observational unit forms a table

---
##Messy data

.center[
<img src="messydata.png" alt="Drawing" style="height: 490px;"/>
]

---
## Grades dataset

```{r grades1}
set.seed(1)

Name <- c("Jasmine", "Kate", "Mike", "Peter", "Thomas")
Test1 <- rnorm(n = 5, mean = c(11, 15, 16, 10, 8), sd = 2) %>% round
Test2 <- rnorm(n = 5, mean = c(11, 15, 16, 10, 8), sd = 2) %>% round
Test3 <- rnorm(n = 5, mean = c(11, 15, 16, 10, 8), sd = 2) %>% round
Test4 <- rnorm(n = 5, mean = c(11, 15, 16, 10, 8), sd = 2) %>% round
Test5 <- rnorm(n = 5, mean = c(11, 15, 16, 10, 8), sd = 2) %>% round

grades <- data.frame(Name, Test1, Test2, Test3, Test4, Test5)
```

```{r grades2, echo=FALSE}
knitr::kable(grades, format = 'html')
```

---
## Tidy datasets with {tidyr}

```{r grades3}
grades_gather <- grades %>% 
  gather(key = Test, value = Grade, -Name)
```

```{r grades4, echo=FALSE}
datatable(grades_gather, fillContainer = FALSE, options = list(pageLength = 7))
```

---

```{r grades5, fig.height=4.5}
ggplot(grades_gather) +
  geom_bar(aes(x = Test, y = Grade, fill = Name), 
           color = "black", stat = "identity") +
  facet_grid(.~Name) +
  guides(fill = FALSE) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

---
class: middle, center, inverse
#Practice makes perfect

---
##Glucose dataset

```{r glucose1}
Glucose <- read.table("Glucose.txt")
```

```{r glucose2, echo=FALSE}
datatable(Glucose, fillContainer = FALSE, options = list(pageLength = 7))
```

---

```{r glucose3, echo=FALSE, warning=FALSE, fig.height=6.2}
Glucose %>%
  mutate(Subject = as.factor(Subject)) %>%
  ggplot(aes(Time, conc, color = Subject)) + 
    geom_point() + 
    geom_line() + 
    facet_wrap(~Meal) +
    theme_bw() +
    labs(x = "Time", y = "Concentration")
```

---

```{r glucose3c, fig.height=4, warning=FALSE}
Glucose %>%
  mutate(Subject = as.factor(Subject)) %>%
  ggplot(aes(Time, conc, color = Subject)) + 
    geom_point() + 
    geom_line() + 
    facet_wrap(~Meal) +
    theme_bw() +
    labs(x = "Time", y = "Concentration")
```

---
```{r glucose4, echo=FALSE, warning=FALSE, fig.height=6.2}
Glucose_stat <- Glucose %>%
  group_by(Time) %>%
  summarise(mean = mean(conc, na.rm = TRUE), median = median(conc, na.rm = TRUE),
            q5 = quantile(conc, probs = 0.05, na.rm = TRUE),
            q95 = quantile(conc, probs = 0.95, na.rm = TRUE))

ggplot(Glucose_stat, aes(x = Time)) +
  geom_errorbar(aes(ymin = q5, ymax = q95)) +
  geom_line(aes(y = mean), color = "blue") +
  geom_point(aes(y = median), color = "red", size = 5) +
  scale_x_continuous(breaks = c(-0.25, 0, 0.5, 1, 1.5, 2, 3, 4, 5, 6, 7)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(y = "Concentration", title = "Summary of Concentration over time",
       caption = "5th and 95th percentile are in black, median is in red and mean in blue.")
```

---

```{r glucose4c, fig.height=2.3, warning=FALSE}
Glucose_stat <- Glucose %>%
  group_by(Time) %>%
  summarise(mean = mean(conc, na.rm = TRUE), median = median(conc, na.rm = TRUE),
            q5 = quantile(conc, probs = 0.05, na.rm = TRUE),
            q95 = quantile(conc, probs = 0.95, na.rm = TRUE))

ggplot(Glucose_stat, aes(x = Time)) +
  geom_errorbar(aes(ymin = q5, ymax = q95)) +
  geom_line(aes(y = mean), color = "blue") +
  geom_point(aes(y = median), color = "red", size = 5) +
  scale_x_continuous(breaks = c(-0.25, 0, 0.5, 1, 1.5, 2, 3, 4, 5, 6, 7)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(y = "Concentration", title = "Summary of Concentration over time",
       caption = "5th and 95th percentile are in black, median is in red and mean in blue.")
```

---
## Pokemon dataset

```{r pkmn1}
Pokemon <- read.table("Pokemon.txt")
Pokemon %<>% mutate(Generation = as.factor(Generation))
```

```{r pkmn2, echo=FALSE}
knitr::kable(Pokemon[1:8,c(2:7,12:13)], format = 'html')
```

---

```{r pkmn3, echo=FALSE, warning=FALSE, fig.height=6.2}
ggplot(Pokemon, aes(x = Generation, y = Total, fill = Generation)) + 
  geom_violin(aes(fill = Generation)) +
  geom_boxplot(alpha = 0) +
  geom_jitter(width = 0.3) +
  scale_fill_discrete(guide = FALSE) +
  labs(x = "Generation", y = "Total statistics") +
  theme_bw()
```

---

```{r pkmn3c, fig.height=4, warning=FALSE}
ggplot(Pokemon, aes(x = Generation, y = Total, fill = Generation)) + 
  geom_violin(aes(fill = Generation)) +
  geom_boxplot(alpha = 0) +
  geom_jitter(width = 0.3) +
  scale_fill_discrete(guide = FALSE) +
  labs(x = "Generation", y = "Total statistics") +
  theme_bw()
```


---

```{r pkmn4, echo=FALSE, warning=FALSE, fig.height=6.2}
Pokemon_poison <- Pokemon %>%
  filter(Type.1 == "Poison" | Type.2 == "Poison") %>%
  arrange(desc(Total))

ggplot(Pokemon_poison, aes(x = Attack, y = Sp..Atk)) +
  geom_smooth(method = "lm", color = "purple") +
  geom_point(color = "purple") +
  geom_text(aes(label = Name), check_overlap = TRUE) +
  theme_bw() +
  labs(y = "Special attack")
```

---

```{r pkmn4c, fig.height=3.3, warning=FALSE}
Pokemon_poison <- Pokemon %>%
  filter(Type.1 == "Poison" | Type.2 == "Poison") %>%
  arrange(desc(Total))

ggplot(Pokemon_poison, aes(x = Attack, y = Sp..Atk)) +
  geom_smooth(method = "lm", color = "purple") +
  geom_point(color = "purple") +
  geom_text(aes(label = Name), check_overlap = TRUE) +
  theme_bw() +
  labs(y = "Special attack")
```

---

```{r pkmn5, echo=FALSE, warning=FALSE, fig.height=6.2}
ggplot(Pokemon, aes(x = 1, fill = Legendary)) + 
  geom_bar(position = "stack") +
  coord_polar(theta = "y") +
  theme_void() +
  labs(x = NULL, y = NULL)
```

---

```{r pkmn5c, fig.height=4, warning=FALSE}
ggplot(Pokemon, aes(x = 1, fill = Legendary)) + 
  geom_bar(position = "stack") +
  coord_polar(theta = "y") +
  theme_void() +
  labs(x = NULL, y = NULL)
```


---

```{r pkmn6, echo=FALSE, warning=FALSE, fig.height=6.2}
pkmn_total_summary <- Pokemon %>% 
  group_by(Generation) %>%
  summarise(Mean = mean(Total), Median = median(Total),
            q25 = quantile(Total, 0.25), q75 = quantile(Total, 0.75)) %>%
  gather(key = Statistic, value = Value, -Generation)

ggplot() + 
  geom_histogram(data = Pokemon, aes(x = Total, fill = Generation), 
                 bins = 80, col = "black") +
  geom_vline(data = pkmn_total_summary, 
             aes(xintercept = Value, linetype = Statistic)) +
  facet_grid(Generation~., scales = "free_y") +
  guides(fill = FALSE) +
  labs(x = "Total statistics", y = "Count") +
  theme_bw()
```

---

```{r pkmn6c, fig.height=2.3, warning=FALSE}
pkmn_total_summary <- Pokemon %>% 
  group_by(Generation) %>%
  summarise(Mean = mean(Total), Median = median(Total),
            q25 = quantile(Total, 0.25), q75 = quantile(Total, 0.75)) %>%
  gather(key = Statistic, value = Value, -Generation)

ggplot() + 
  geom_histogram(data = Pokemon, aes(x = Total, fill = Generation), 
                 bins = 80, col = "black") +
  geom_vline(data = pkmn_total_summary, 
             aes(xintercept = Value, linetype = Statistic)) +
  facet_grid(Generation~., scales = "free_y") +
  guides(fill = FALSE) +
  labs(x = "Total statistics", y = "Count") +
  theme_bw()
```

---
class: middle, center, inverse
# Going further and references

---
### ggplot2

* ggplot2: Elegant Graphics for Data Analysis (Hadley Wickham)

* [**R User Grenoble presentation**](https://privefl.github.io/R-presentation/ggplot2.html)

### Tidy data

* [**Tidy data**](http://tidyr.tidyverse.org/articles/tidy-data.html)

* [**Messy data**](https://medium.com/@miles.mcbain/tidying-the-australian-same-sex-marriage-postal-survey-data-with-r-5d35cea07962)


### Visualisation

* [**The Worst Chart In The World**](http://www.businessinsider.fr/us/pie-charts-are-the-worst-2013-6/)



---
class: center, middle, inverse

# Thanks for your attention :) 

<a href="mailto:antoine.bichat@mines-nancy.org">antoine.bichat@mines-nancy.org</a> 


.footnote[Slides created via the R package [**xaringan**](https://github.com/yihui/xaringan).]

